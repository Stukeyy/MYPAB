image: php:7.4

stages:
  - install
  - lint
  - integrate


install:
  stage: install
  image: composer:latest
  tags:
    - project
  before_script:
    - echo "Install Stage"
    - composer
  script:
    - echo $TEST
    - composer install
  only:
    - cicd


lint:
  stage: lint
  image: composer:latest
  tags:
    - project
  before_script:
    - echo "Lint Stage"
  script:
    - composer require overtrue/phplint:^3.0 --dev -vvv
    - ./vendor/bin/phplint ./ --exclude=vendor
  only:
    - cicd


integrate:
  stage: integrate
  tags:
    - project
  script:
    - ls public
    - rm -r public/static
    - ls resources/views
    - rm resources/views/index.blade.php
    - 'curl --location --output artifacts.zip --header "PRIVATE-TOKEN: ${TOKEN}" --request GET "https://gitlab.com/api/v4/projects/30472412/jobs/artifacts/cicd/download?job=build"'
    - unzip artifacts.zip
    - cp -r ./dist/static ./public
    - cp -r ./dist/index.html ../backend/resources/views/index.blade.php
    - ls public
    - ls resources/views
  only:
    - cicd